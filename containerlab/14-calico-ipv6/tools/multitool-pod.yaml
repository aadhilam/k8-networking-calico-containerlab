# Test pods for dual-stack connectivity testing
# These pods can reach both IPv4 and IPv6 external destinations

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: multitool
  labels:
    app: multitool
spec:
  selector:
    matchLabels:
      app: multitool
  template:
    metadata:
      labels:
        app: multitool
    spec:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
        - name: multitool
          image: wbitt/network-multitool:alpine-extra
          env:
            - name: HTTP_PORT
              value: "8080"
          # Configure nginx to listen on both IPv4 and IPv6
          command: ["/bin/sh", "-c"]
          args:
            - |
              cat > /etc/nginx/nginx.conf << 'EOF'
              worker_processes 1;
              events { worker_connections 1024; }
              http {
                server {
                  listen 8080;
                  listen [::]:8080;
                  location / {
                    return 200 'Dual-Stack Pod - IPv4 and IPv6 enabled\n';
                    add_header Content-Type text/plain;
                  }
                }
              }
              EOF
              nginx -g 'daemon off;'

---
# Dual-stack service
apiVersion: v1
kind: Service
metadata:
  name: multitool-dual-stack
  labels:
    app: multitool
spec:
  ipFamilyPolicy: RequireDualStack
  ipFamilies:
    - IPv4
    - IPv6
  type: ClusterIP
  selector:
    app: multitool
  ports:
    - port: 80
      targetPort: 8080

---
# IPv6-only service
apiVersion: v1
kind: Service
metadata:
  name: multitool-ipv6-only
  labels:
    app: multitool
spec:
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv6
  type: ClusterIP
  selector:
    app: multitool
  ports:
    - port: 80
      targetPort: 8080
